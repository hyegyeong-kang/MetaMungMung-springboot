<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.metanet.metamungmung.mapper.meeting.OnMeetingMapper">

<!--    On모임 생성-->
    <insert id="createOnMeeting">
        insert into onMeeting
        values
            (#{onMeetingIdx}, #{onMeetName}, #{category}, #{introduction, jdbcType=VARCHAR}, #{thumbnail, jdbcType=VARCHAR},
             #{isPublic}, #{onMeetingAddr, jdbcType=VARCHAR}, sysdate, sysdate)
        <selectKey keyProperty="onMeetingIdx" order="BEFORE" resultType="long">
            select onMeeting_seq.nextval from dual
        </selectKey>
    </insert>

<!--    On모임 정보 수정-->
    <update id="modifyOnMeeting">
        update onMeeting
        set
            onMeetName = #{onMeetName}, category = #{category}, introduction = #{introduction},
            thumbnail = #{thumbnail}, isPublic = #{isPublic}, onMeetingAddr = #{onMeetingAddr},
            createDate = #{createDate}
        where
            onMeetingIdx = #{onMeetingIdx}
    </update>

<!--    On모임 삭제-->
    <delete id="removeOnMeeting">
        delete from onMeeting
        where onMeetingIdx = #{onMeetingIdx}
    </delete>

<!--    On모임 상세 (+ 멤버수, 호스트 이름!!!)-->
    <select id="getOnMeetingById" resultType="com.metanet.metamungmung.dto.meeting.OnMeetingDTO">
        select * from onMeeting where onMeetingIdx = #{onMeetingIdx}
    </select>
    
<!--    My On모임 리스트-->
    <select id="getOnMeetingListByMember" resultMap="onMeetingMap">
        select * from onMeeting meet
            join onMeetingMem mem on meet.onMeetingIdx = mem.onMeetingIdx
            join member m on mem.memberIdx = m.memberIdx
                where memberIdx = #{memberIdx}
    </select>
    
    <resultMap id="onMeetingMap" type="com.metanet.metamungmung.dto.meeting.OnMeetingDTO">
        <result property="onMeetingIdx" column="onMeetingIdx"/>
        <result property="onMeetName" column="onMeetName"/>
        <result property="category" column="category"/>
        <result property="introduction" column="introduction"/>
        <result property="thumbnail" column="thumbnail"/>
        <result property="isPublic" column="isPublic"/>
        <result property="onMeetingAddr" column="onMeetingAddr"/>
        <collection property="com.metanet.metamungmung.dto.meeting.OnMeetingMemDTO" resultMap="onMeetingMemMap"/>
    </resultMap>

    <resultMap id="onMeetingMemMap" type="com.metanet.metamungmung.dto.meeting.OnMeetingMemDTO">
        <result property="onMeetingMemIdx" column="onMeetingMemIdx"/>
        <result property="onMeetingIdx" column="onMeetingIdx"/>
        <result property="memberIdx" column="memberIdx"/>
        <result property="joinDate" column="joinDate"/>
        <result property="isHost" column="isHost"/>
        <association property="com.metanet.metamungmung.dto.member.MemberDTO" resultMap="memberMap"/>
    </resultMap>

    <resultMap id="memberMap" type="com.metanet.metamungmung.dto.member.MemberDTO">
        <result property="memberIdx" column="memberIdx"/>
        <result property="memberId" column="memberId"/>
        <result property="memberName" column="memberName"/>
        <result property="sex" column="sex"/>
        <result property="birth" column="birth"/>
        <result property="email" column="email"/>
        <result property="memberImg" column="memberImg"/>
    </resultMap>

<!--    추천 On모임 리스트-->
    <select id="getRecommendOnMeetingList" resultMap="onMeetingMap">
        select * from onMeeting meet
                          join onMeetingMem mem on meet.onMeetingIdx = mem.onMeetingIdx
                          join member m on mem.memberIdx = m.memberIdx
        where memberIdx != #{memberIdx}
    </select>

    <resultMap id="onMeetingMap" type="com.metanet.metamungmung.dto.meeting.OnMeetingDTO">
        <result property="onMeetingIdx" column="onMeetingIdx"/>
        <result property="onMeetName" column="onMeetName"/>
        <result property="category" column="category"/>
        <result property="introduction" column="introduction"/>
        <result property="thumbnail" column="thumbnail"/>
        <result property="isPublic" column="isPublic"/>
        <result property="onMeetingAddr" column="onMeetingAddr"/>
        <collection property="com.metanet.metamungmung.dto.meeting.OnMeetingMemDTO" resultMap="onMeetingMemMap"/>
    </resultMap>

    <resultMap id="onMeetingMemMap" type="com.metanet.metamungmung.dto.meeting.OnMeetingMemDTO">
        <result property="onMeetingMemIdx" column="onMeetingMemIdx"/>
        <result property="onMeetingIdx" column="onMeetingIdx"/>
        <result property="memberIdx" column="memberIdx"/>
        <result property="joinDate" column="joinDate"/>
        <result property="isHost" column="isHost"/>
        <association property="com.metanet.metamungmung.dto.member.MemberDTO" resultMap="memberMap"/>
    </resultMap>

    <resultMap id="memberMap" type="com.metanet.metamungmung.dto.member.MemberDTO">
        <result property="memberIdx" column="memberIdx"/>
        <result property="memberId" column="memberId"/>
        <result property="memberName" column="memberName"/>
        <result property="sex" column="sex"/>
        <result property="birth" column="birth"/>
        <result property="email" column="email"/>
        <result property="memberImg" column="memberImg"/>
    </resultMap>

</mapper>